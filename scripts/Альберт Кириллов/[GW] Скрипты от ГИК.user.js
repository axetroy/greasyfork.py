// ==UserScript==
// @name [GW] Скрипты от ГИК
// @description Набор полезных мини-скриптов для GanjaWars.ru
// @author ГИК
// @version 1.1
// @include http://www.ganjawars.ru/*
// @namespace http://www.ganjawars.ru/info.php?id=2202018
// @grant none
// ==/UserScript==
!function(t,e){function o(t,e,i){if("undefined"!=typeof GM_xmlhttpRequest&&void 0===document.all)GM_xmlhttpRequest({method:e,url:t,onload:i});else if("undefined"!=typeof Ajax)new Ajax.Request(t,{method:e,onComplete:i});else if(null==n.document.getElementById("fwprototype")){var a=n.document.createElement("script");a.id="fwprototype",a.type="text/javascript",a.src="http://www.prototypejs.org/assets/2007/1/18/prototype.js",n.document.body.appendChild(a),n.setTimeout(function(){o(t,e,i)},100)}else n.setTimeout(function(){o(t,e,i)},100)}var n;if((n=void 0!=typeof unsafeWindow?unsafeWindow:t).self==n.top&&/ganjawars.ru/.test(n.location.href))if(n.s=JSON.parse(localStorage.getItem("sets")),null!=s&&void 0!=s){if(/\/info.php/.test(n.location.href)&&s.carmaCh&&!/valign=.?middle.?><div>/.test(n.document.body.innerHTML)){for(var i=n.document.getElementsByTagName("b"),a=0;a<i.length;a++)if("Карма:"==i[a].innerHTML){var l=n.document.createElement("node");l.setAttribute("id","voteBar"),l.innerHTML="<img style='vertical-align:-1.5px;cursor:progress;' src='https://user-images.githubusercontent.com/10257481/32316536-b8f05c92-c004-11e7-8f4f-d45d7c3d246a.gif'>",i[a].parentNode.appendChild(l)}o("http://www.ganjawars.ru/info.php?id=777777","GET",function(t){var e=!1;try{e=/&cf=(\w*)/.exec(t.responseText)[1]}catch(t){}var o=/id=(\d*)/.exec(n.location.href)[1];l.innerHTML=e?"<style>.VB {cursor:pointer;width:7px;height:7px;margin-left:2px;}</style>[<a title='Отправить Ваш голос повторно: -3' href='http://www.ganjawars.ru/info.vote.php?id="+o+"&vote=-3&cf="+e+"'><img class='VB' style='background-color:#000099;' src='http://images.ganjawars.ru/i/t.gif'></a><a title='Отправить Ваш голос повторно: 0' href='http://www.ganjawars.ru/info.vote.php?id="+o+"&vote=0&cf="+e+"'><img class='VB' style='background-color:#009900;' src='http://images.ganjawars.ru/i/t.gif'></a><a title='Отправить Ваш голос повторно: 3' href='http://www.ganjawars.ru/info.vote.php?id="+o+"&vote=3&cf="+e+"'><img class='VB' style='margin-right:2px;background-color:#990000;' src='http://images.ganjawars.ru/i/t.gif'></a>]":""})}if(n.nameClear=function(t){""==t.value?t.value="[ введите название нового фильтра ]":"[ введите название нового фильтра ]"==t.value&&(t.value="")},n.delWiget=function(t,e){e.parentNode.parentNode.parentNode.parentNode.remove();var o=JSON.parse(localStorage.getItem("listWiget"));o.splice(t,1),localStorage.setItem("listWiget",JSON.stringify(o))},n.wigetBarMngr=function(t){for(var e=n.document.getElementsByTagName("center"),o=!1,i=0;i<e.length;i++)/>Базы и склады</.test(e[i].innerHTML)&&(o=i);switch(t){case 0:var a=n.document.createElement("div");a.setAttribute("style","margin:10px auto 0 auto;width:604px;"),a.innerHTML="<input type='submit' onClick='wigetBarMngr(1); this.remove();' style='width:600px;' value='Добавить новый фильтр' class='mainbutton'>",e[o].parentNode.insertBefore(a,e[o].nextSibling);break;case 1:n.scrollTo(0,0);var l=n.document.createElement("div");l.setAttribute("id","newBarWiget"),l.setAttribute("style","margin:10px auto;width:587px;background-color:#d0eed0;border: 1px #339933 solid; padding: 5px;"),l.innerHTML="<b><input id='newName' style='width:240px;text-align:center;margin-left:170px;' onfocusout='nameClear(this)' onClick='nameClear(this)' value='[ введите название нового фильтра ]'><br/>Выберите необходимые параметры фильтра:</b><br/><span>Уровень от <select id='newMin'><option value=10 selected>10</option><option value=11 >11</option><option value=12 >12</option><option value=13 >13</option><option value=14 >14</option><option value=15 >15</option><option value=16 >16</option><option value=17 >17</option><option value=18 >18</option><option value=19 >19</option><option value=20 >20</option><option value=21 >21</option><option value=22 >22</option><option value=23 >23</option><option value=24 >24</option><option value=25 >25</option><option value=26 >26</option><option value=27 >27</option><option value=28 >28</option><option value=29 >29</option><option value=30 >30</option><option value=31 >31</option><option value=32 >32</option><option value=33 >33</option><option value=34 >34</option><option value=35 >35</option><option value=36 >36</option><option value=37 >37</option><option value=38 >38</option><option value=39 >39</option><option value=40 >40</option><option value=41 >41</option><option value=42 >42</option><option value=43 >43</option><option value=44 >44</option><option value=45 >45</option><option value=46 >46</option><option value=47 >47</option><option value=48 >48</option><option value=49 >49</option><option value=50 >50</option></select> до <select id='newMax'><option value=10 >10</option><option value=11 >11</option><option value=12 >12</option><option value=13 >13</option><option value=14 >14</option><option value=15 >15</option><option value=16 >16</option><option value=17 >17</option><option value=18 >18</option><option value=19 >19</option><option value=20 >20</option><option value=21 >21</option><option value=22 >22</option><option value=23 >23</option><option value=24 >24</option><option value=25 >25</option><option value=26 >26</option><option value=27 >27</option><option value=28 >28</option><option value=29 >29</option><option value=30 >30</option><option value=31 >31</option><option value=32 >32</option><option value=33 >33</option><option value=34 >34</option><option value=35 >35</option><option value=36 >36</option><option value=37 >37</option><option value=38 >38</option><option value=39 >39</option><option value=40 >40</option><option value=41 >41</option><option value=42 >42</option><option value=43 >43</option><option value=44 >44</option><option value=45 >45</option><option value=46 >46</option><option value=47 >47</option><option value=48 >48</option><option value=49 >49</option><option value=50 selected>50</option></select>, сортировать <select id='newSort'><option value=0 >по % HP</option><option value=1 >по уровню</option><option value=2 >как есть</option></select></span><input style='float:right;' type='submit' onClick='wigetBarMngr(2)' value='Сохранить' class='mainbutton'>",e[o].parentNode.insertBefore(l,e[o].nextSibling);break;case 2:var r=n.document.getElementById("newName").value,p=n.document.getElementById("newMin");p=p.options[p.selectedIndex].value;var s=n.document.getElementById("newMax");s=s.options[s.selectedIndex].value;var u=n.document.getElementById("newSort");u=u.options[u.selectedIndex].value;var c=String([r,p,s,u]),d=JSON.parse(localStorage.getItem("listWiget"));null==d||void 0==d?(d=[c],localStorage.setItem("listWiget",JSON.stringify(d))):(d.push(c),localStorage.setItem("listWiget",JSON.stringify(d)));for(var g=[],v=n.document.getElementsByTagName("tr"),o=!1,i=0;i<v.length;i++)/\d+ бойцов онлайн/.test(v[i].innerHTML)?o=/(\d+) бойцов онлайн/.exec(v[i].innerHTML)[1]:o>0&&(g[g.length]=v[i].innerHTML,o--);v=n.document.getElementsByTagName("center");for(i=0;i<v.length;i++)/>Базы и склады</.test(v[i].innerHTML)&&i;var m,f,h,b,w=d.length-1;switch((b=String(d[w]).split(","))[3]){case"0":g.sort(function(t,e){var o=/>(\d+)\/(\d+)<\/font>/.exec(t);o=Math.round(o[1]/o[2]*100);var n=/>(\d+)\/(\d+)<\/font>/.exec(e);return(n=Math.round(n[1]/n[2]*100))-o}),h="HP";break;case"1":g.sort(function(t,e){var o=Number(/>\[(\d+)\]\[\d+\]/.exec(t)[1]);return Number(/>\[(\d+)\]\[\d+\]/.exec(e)[1])-o}),h="LVL";break;case"2":h="без сортировки"}(m=n.document.getElementById("newBarWiget")).setAttribute("style","margin:10px auto 0px auto;width:602px;"),f="<table class='wb' width='600' cellspacing='1' cellpadding='1' align='center'><tbody><tr><td colspan='8' class='wb' bgcolor='#d0eed0' align='center'><b>"+b[0]+"</b> [<font color='red'>"+b[1]+"-"+b[2]+"</font>, <font color='blue'>"+h+"</font>]<font onClick='delWiget("+w+", this)' style='float:right;cursor:pointer;' color='darkgreen'><b>Удалить [Х]</b></font></td></tr>";for(var y,i=0;i<g.length;i++)(y=Number(/>\[(\d+)\]\[\d+\]/.exec(g[i])[1]))>=Number(b[1])&&y<=Number(b[2])&&(f+="<tr style='background-color:#ffffff'>"+g[i]+"</tr>");m.innerHTML=f+"</tbody></table>"}},/syndicate\.php\?id=\d+&page=online/.test(n.location.href)&&s.sindOn){wigetBarMngr(0);for(var r=JSON.parse(localStorage.getItem("listWiget")),p=[],u=n.document.getElementsByTagName("tr"),c=!1,d=0,a=0;a<u.length;a++)/\d+ бойцов онлайн/.test(u[a].innerHTML)?c=/(\d+) бойцов онлайн/.exec(u[a].innerHTML)[1]:c>0&&(p[p.length]=u[a].innerHTML,c--);u=n.document.getElementsByTagName("center");for(a=0;a<u.length;a++)/>Базы и склады</.test(u[a].innerHTML)&&(d=a);for(var g,v,m,f,h=0;h<r.length;h++){switch((f=String(r[h]).split(","))[3]){case"0":p.sort(function(t,e){var o=/>(\d+)\/(\d+)<\/font>/.exec(t);o=Math.round(o[1]/o[2]*100);var n=/>(\d+)\/(\d+)<\/font>/.exec(e);return(n=Math.round(n[1]/n[2]*100))-o}),m="HP";break;case"1":p.sort(function(t,e){var o=Number(/>\[(\d+)\]\[\d+\]/.exec(t)[1]);return Number(/>\[(\d+)\]\[\d+\]/.exec(e)[1])-o}),m="LVL";break;case"2":m="без сортировки"}(g=n.document.createElement("div")).setAttribute("class","BarWiget"),u[d].parentNode.insertBefore(g,u[d].nextSibling),g.setAttribute("style","margin:10px auto 0px auto;width:602px;"),v="<table class='wb' width='600' cellspacing='1' cellpadding='1' align='center'><tbody><tr><td colspan='8' class='wb' bgcolor='#d0eed0' align='center'><b>"+f[0]+"</b> [<font color='red'>"+f[1]+"-"+f[2]+"</font>, <font color='blue'>"+m+"</font>]<font onClick='delWiget("+h+", this)' style='float:right;cursor:pointer;' color='darkgreen'><b>Удалить [Х]</b></font></td></tr>";for(var b,a=0;a<p.length;a++)(b=Number(/>\[(\d+)\]\[\d+\]/.exec(p[a])[1]))>=Number(f[1])&&b<=Number(f[2])&&(v+="<tr style='background-color:#ffffff'>"+p[a]+"</tr>");g.innerHTML=v+"</tbody></table>"}}if(n.chSettings=function(){var t=JSON.parse(localStorage.getItem("sets"));t.carmaCh=document.getElementById("carmaCh").checked,t.sindOn=document.getElementById("sindOn").checked,localStorage.setItem("sets",JSON.stringify(t))},/\/info\.edit\.php/.test(n.location.href)){for(var u=n.document.getElementsByTagName("tr"),c=!1,a=0;a<u.length;a++)/Сохранить все основные настройки/.test(u[a].innerHTML)&&(c=a);if(c){var w=n.document.createElement("tr");w.innerHTML="<td class='greenbg' align='center' colspan='2'><b>Настройки Юзабилити от <a href='/info.php?id=2202018'>ГИК</a> (сохраняются автоматически)</b></td>",u[c].parentNode.insertBefore(w,u[c]),c++,(w=n.document.createElement("tr")).innerHTML="<td width='60%' class='greenbg' align='right'>Включить возможность повторного изменения кармы игроков</td><td width='40%' class='greenlightbg' valign='top'><input type='checkbox' onclick='chSettings()' id='carmaCh'"+(s.carmaCh?" checked":"")+"></td>",u[c].parentNode.insertBefore(w,u[c]),c++,(w=n.document.createElement("tr")).innerHTML="<td width='60%' class='greenbg' align='right'>Включить фильтр онлайна синдикатов</td><td width='40%' class='greenlightbg' valign='top'><input type='checkbox' onclick='chSettings()' id='sindOn'"+(s.sindOn?" checked":"")+"></td>",u[c].parentNode.insertBefore(w,u[c])}}}else{var y={carmaCh:!0,sindOn:!0};localStorage.setItem("sets",JSON.stringify(y)),localStorage.setItem("listWiget",JSON.stringify(null))}}(window);