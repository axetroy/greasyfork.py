// ==UserScript==
// @icon           http://i.imgur.com/qSgClQp.png
// @name           CENTER DRIVEN Alliance Dashboard 
// @author         XDaast
// @description    Advanced Alliance Management and Information Tool
// @namespace      https://prodgame*.alliances.commandandconquer.com/*/index.aspx*
// @include        https://prodgame*.alliances.commandandconquer.com/*/index.aspx*
// @grant          none
// @version        3.0
// ==/UserScript==
function initADReport(){var k=document.createElement("script");k.innerHTML="("+function(){function k(){qx.Class.define("AD",{type:"singleton",extend:qx.core.Object,members:{data:null,mail:null,ui:null,intervalUpdate:null,initialize:function(){this.data=ADDataProvider.getInstance().initialize();this.ui=ADUserInterface.getInstance().initialize()}}},qx.Class.define("ADDataProvider",{type:"singleton",extend:qx.core.Object,members:{mainData:null,alliance:null,members:null,pois:[],poiTypes:[],poiColors:[],
initialize:function(){this.mainData=ClientLib.Data.MainData.GetInstance();this.player=this.mainData.get_Player();this.alliance=this.mainData.get_Alliance();this.members=this.initMemberData();this.pois=this.initPois();return this},initMemberData:function(){var a=this.alliance.get_MemberData().d,c=[],b;for(b in a){var d=new Date(a[b].LastSeen),g=d.getHours();10>g&&(g="0"+g);var e=d.getMinutes();10>e&&(e="0"+e);var f=d.getSeconds();10>f&&(f="0"+f);var h=d.getDate(),l=d.getMonth(),d=d.getFullYear(),g=
l+1+"/"+h+"/"+d+" "+g+":"+e+":"+f,e="Hidden";0==a[b].OnlineState&&(e="Offline");1==a[b].OnlineState&&(e="Online");2==a[b].OnlineState&&(e="Away");c.push([a[b].Id,a[b].Name,a[b].Rank,a[b].Points,a[b].Bases,e,g])}return c},getMemberData:function(){return this.members},doRequest:function(a,c,b){ClientLib.Net.CommunicationManager.GetInstance().SendSimpleCommand(a,c,phe.cnc.Util.createEventDelegate(ClientLib.Net.CommandResult,this,this.commandCallback),b)},commandCallback:function(a,c){switch(a){case "GetMemberDataForDetailMemberTab":ADUserInterface.getInstance().populateDetailMemberTab(c);
break;case "GetBaseReportDataForDetailMemberBasesTabs":ADUserInterface.getInstance().populateBaseReportDetailMemberBaseTab(c);break;case "GetMemberDataForDetailRosterTab":ADUserInterface.getInstance().populateDetailRosterTab(c)}},initPois:function(){this.poiTypes["2"]="Tiberium";this.poiTypes["3"]="Crystal";this.poiTypes["4"]="Reactor";this.poiTypes["5"]="Infantry";this.poiTypes["6"]="Ground";this.poiTypes["7"]="Air";this.poiTypes["8"]="Defense";this.poiColors["2"]="00FF37";this.poiColors["3"]="8A54FF";
this.poiColors["4"]="77F0FC";this.poiColors["5"]="E6FF00";this.poiColors["6"]="FFB13D";this.poiColors["7"]="FF5757";this.poiColors["8"]="FF73B0";var a=this.alliance.get_OwnedPOIs(),c;for(c in a){var b=a[c];this.pois.push(['<span style="background:#'+this.poiColors[b.t]+';display:block;width:15px;height:15px;">&nbsp;</span>',this.poiTypes[b.t],b.l,b.x,b.y])}return this.pois},getPois:function(){return this.pois},getPoiTypes:function(){return this.poiTypes},getAlliance:function(){return this.alliance},
getNameByIdx:function(a,c){var b=0,d;for(d in a){if(b==c)return d;b++}return null}}}));qx.Class.define("ADUserInterface",{type:"singleton",extend:qx.core.Object,members:{adWindow:null,data:null,UIDetailGroupbox:null,UITabsCities:[],initialize:function(){this.data=ADDataProvider.getInstance();this.initMenu()},initMenu:function(){var a=qx.core.Init.getApplication().getUIItem(ClientLib.Data.Missions.PATH.BAR_NAVIGATION),c=new qx.ui.form.Button("","http://i.imgur.com/0VF4Rzr.png");c.set({center:!0,show:"icon",
alignY:"middle",width:40,height:50,toolTipText:"GET TO THE CENTER FOOL!",appearance:"button-text-small"});c.addListener("click",function(){ADUserInterface.getInstance().openADWindow()},this);a.add(c)},initADWindow:function(){if(null!=this.adWindow)return this.adWindow;var a=new qx.ui.window.Window("CENTER DRIVEN Alliance Management: "+this.data.getAlliance().get_Name());a.set({layout:new qx.ui.layout.VBox(10),showMaximize:!0,showMinimize:!1,alignX:"center",alignY:"middle",width:1E3,height:660,minWidth:100,
minHeight:200,showStatusbar:!0,textColor:"#4E5661"});a.addListener("close",function(a){this.adWindow=null},this);var c=new qx.ui.tabview.TabView,b=this.initAdWindowRosterTab();c.add(b,{flex:1});b=this.initAdWindowMembersTab();c.add(b,{flex:1});b=this.initAdWindowPoiTab();c.add(b,{flex:1});b=this.initAdWindowRankTab();c.add(b,{flex:1});a.add(c,{flex:1});c=new qx.ui.form.Slider;c.set({value:100,minimum:0,maximum:100,singleStep:1,pageStep:20});a.add(c);c.addListener("changeValue",function(a){a=a.getData()/
100;this.adWindow.set({opacity:a})},this);return this.adWindow=a},openADWindow:function(){null==this.adWindow&&this.initADWindow();this.adWindow.open();this.adWindow.center();this.adWindow.set({opacity:1})},initAbstractTab:function(a){a.setOpacity(1);return a},initAdWindowRosterTab:function(){var a=new qx.ui.tabview.Page("Roster"),a=this.initAbstractTab(a);a.setLayout(new qx.ui.layout.HBox(10));var c=new qx.ui.groupbox.GroupBox("Member Statistics");c.setLayout(new qx.ui.layout.VBox(10));a.add(c,{flex:1,
width:"100%"});var b=new qx.ui.table.model.Simple;b.setColumns("Id;Name;Rank;Points;Bases;Online;Last Online".split(";"));var d=this.data.getMemberData();b.setData(d);b=(new qx.ui.table.Table(b)).set({decorator:null});d=new qx.ui.groupbox.GroupBox("Attack Logs (per base)");c.add(b,{flex:1});d.setLayout(new qx.ui.layout.VBox(10));this.UIDetailGroupbox=d;a.add(this.UIDetailGroupbox,{flex:1,width:"0%"});return a},initAdWindowDetailRosterTab:function(a){this.data.doRequest("GetPublicPlayerInfo",{id:a},
"GetMemberDataForDetailRosterTab")},initAdWindowMembersTab:function(){var a=new qx.ui.tabview.Page("PvE & PvP Attack Logs"),a=this.initAbstractTab(a);a.setLayout(new qx.ui.layout.HBox(10));var c=new qx.ui.groupbox.GroupBox("Members");c.setLayout(new qx.ui.layout.VBox(10));a.add(c,{flex:1,width:"50%"});var b=new qx.ui.table.model.Simple;b.setColumns(["Id","Name","Rank"]);var d=this.data.getMemberData();b.setData(d);var b=(new qx.ui.table.Table(b)).set({decorator:null}),g=new qx.ui.groupbox.GroupBox("Attack Logs (per base)");
b.addListener("cellClick",function(a){a=d[a.$$user_row][0];g.removeAll();this.initAdWindowDetailMemberTab(a)},this);c.add(b,{flex:1});g.setLayout(new qx.ui.layout.VBox(10));this.UIDetailGroupbox=g;a.add(this.UIDetailGroupbox,{flex:1,width:"50%"});return a},initAdWindowDetailMemberTab:function(a){this.data.doRequest("GetPublicPlayerInfo",{id:a},"GetMemberDataForDetailMemberTab")},initAdWindowPoiTab:function(){var a=new qx.ui.tabview.Page("POI"),a=this.initAbstractTab(a);a.setLayout(new qx.ui.layout.HBox(10));
var c=new qx.ui.groupbox.GroupBox("POI Management");c.setLayout(new qx.ui.layout.VBox(10));a.add(c,{flex:1});var b=new qx.ui.table.model.Simple;b.setColumns(["-","Type","Level","X","Y"]);var d=this.data.getPois();b.setData(d);b=(new qx.ui.table.Table(b,{tableColumnModel:function(a){return new qx.ui.table.columnmodel.Resize(a)}})).set({decorator:null});b.addListener("cellClick",function(a){webfrontend.gui.UtilView.centerCoordinatesOnRegionViewWindow(parseInt(d[a.$$user_row][3],10),parseInt(d[a.$$user_row][4],
10))},this);b.getTableColumnModel().getBehavior().set(0,{width:"1*",minWidth:20,maxWidth:30});var g=new qx.ui.table.cellrenderer.Html;b.getTableColumnModel().setDataCellRenderer(0,g);c.add(b,{flex:1});c=new qx.ui.groupbox.GroupBox("POI");c.setLayout(new qx.ui.layout.VBox(10));a.add(c,{flex:1,width:"0%"});return a},initAdWindowRankTab:function(){var a=new qx.ui.tabview.Page("POI Ratings"),a=this.initAbstractTab(a);a.setLayout(new qx.ui.layout.HBox(10));var c=this.data.alliance,b=new qx.ui.table.model.Simple;
b.setColumns(["Type","Rate","Score","Next Step","Further Information"]);var d=c.get_POIRankScore(),g=[[0,0,0],[5,14,3E3],[16,17,4E3],[27,20,5500],[50,23,7E3],[90,26,8500],[160,29,1E4],[260,32,12E3],[420,35,15E3],[750,38,18E3],[1300,41,22E3],[2200,44,26E3],[3600,47,3E4],[5700,50,36E3],[9700,53,45E3],[16400,56,6E4],[28E3,58,8E4],[44E3,60,105E3],[8E4,62,135E3],[115E3,64,17E4],[19E4,66,215E3],[33E4,68,27E4]],e=[],f;for(f in d)for(var h in d[f])for(var l in g)if(!(g[l][0]<=d[f].s)){e[f]=g[l][0];break}g=
["General",c.get_Rank(),c.get_TotalScore(),"/"];f=["POI Tiberium",d[0].r,d[0].s,e[0],"Bonus: "+c.get_POITiberiumBonus()+"/h"];h=["POI Crystal",d[1].r,d[1].s,e[1],"Bonus: "+c.get_POICrystalBonus()+"/h"];l=["POI Reactor",d[2].r,d[2].s,e[2],"Bonus: "+c.get_POIPowerBonus()+"/h"];var m=["POI Infantry",d[3].r,d[3].s,e[3],"Bonus: "+c.get_POIInfantryBonus()+"%"],k=["POI Ground",d[4].r,d[4].s,e[4],"Bonus: "+c.get_POIVehicleBonus()+"%"],n=["POI Air",d[5].r,d[5].s,e[5],"Bonus: "+c.get_POIAirBonus()+"%"],c=["POI Defense",
d[6].r,d[6].s,e[6],"Bonus: "+c.get_POIDefenseBonus()+"%"],d=[];d.push(g,f,h,l,m,k,n,c);b.setData(d);b=(new qx.ui.table.Table(b)).set({decorator:null});a.add(b,{flex:1});return a},populateDetailMemberTab:function(a){var c=new qx.ui.tabview.TabView,b=new qx.ui.tabview.Page("History"),b=this.initAbstractTab(b);b.setLayout(new qx.ui.layout.VBox(10));var d=new qx.ui.tabview.TabView;a=a.c;for(var g in a){var e=a[g],f=new qx.ui.tabview.Page(e.n);f.setLayout(new qx.ui.layout.VBox(10));var h=(new qx.ui.basic.Label("Combat Reports")).set({textColor:"text-value",
font:"font_size_13_bold"});f.add(h);this.UITabsCities[e.i]=f;this.data.doRequest("GetReportHeaderBase",{ascending:!1,baseId:e.i,skip:0,sort:1,take:200,type:1},"GetBaseReportDataForDetailMemberBasesTabs");d.add(f,{flex:1})}b.add(d,{flex:1});c.add(b,{flex:1});this.UIDetailGroupbox.add(c,{flex:1})},populateBaseReportDetailMemberBaseTab:function(a){if(0==a.length)return!0;var c=a[0].bi,b=[];b.img="none";b.img0="0";b.img1='<img src="https://eaassets-a.akamaihd.net/cncalliancesgame/cdn/data/5aaca4e32fdcbc59a332a90ab09560fd.png" />';
b.img2="2";b.img3="3";b.img4='<img src="https://eaassets-a.akamaihd.net/cncalliancesgame/cdn/data/d0b7b7f9cceaf177eeb45703dd5b8583.png" />';b.img5='<img src="https://eaassets-a.akamaihd.net/cncalliancesgame/cdn/data/8b3f702643d0916531dd088032c0b14e.png" />';b.img6='<img src="https://eaassets-a.akamaihd.net/cncalliancesgame/cdn/data/d0b7b7f9cceaf177eeb45703dd5b8583.png" />';c=this.UITabsCities[c];c.removeAll();var d=new qx.ui.table.model.Simple;d.setColumns(["Result","Type","Time"]);var g=[],e;for(e in a){var f=
a[e],h=f.ad,l="Attack: "+h.dbn;2==h.dbn&&(l="<span style='color:green;'>Attack: Camp lvl "+h.dbl+"</span>");3==h.dbn&&(l="<span style='color:#ff8c00;'>Attack: Outpost lvl "+h.dbl+"</span>");4==h.dbn&&(l="<span style='color:red;'>Attack: Base lvl "+h.dbl+"</span>");var m=new Date(f.t),f=m.getHours();10>f&&(f="0"+f);var k=m.getMinutes();10>k&&(k="0"+k);var n=m.getSeconds();10>n&&(n="0"+n);var p=m.getDate(),q=m.getMonth(),m=m.getFullYear();g.push([b["img"+h.cr],l,q+1+"/"+p+"/"+m+" "+f+":"+k+":"+n])}d.setData(g);
a=(new qx.ui.table.Table(d,{tableColumnModel:function(a){return new qx.ui.table.columnmodel.Resize(a)}})).set({decorator:null});b=a.getTableColumnModel().getBehavior();b.setWidth(0,60);b.set(1,{width:"1*",minWidth:100,maxWidth:600});b=new qx.ui.table.cellrenderer.Html;a.getTableColumnModel().setDataCellRenderer(0,b);a.getTableColumnModel().setDataCellRenderer(1,b);c.add(a,{flex:1})}}})}function p(){try{"undefined"!=typeof qx?null!==qx.core.Init.getApplication().getMenuBar()?(k(),AD.getInstance().initialize()):
setTimeout(p,1E3):setTimeout(p,1E3)}catch(a){"undefined"!=typeof console?console.log(a):window.opera?opera.postError(a):GM_log(a)}}/commandandconquer\.com/i.test(document.domain)&&setTimeout(p,1E3)}.toString()+")();";k.type="text/javascript";/commandandconquer\.com/i.test(document.domain)&&document.getElementsByTagName("head")[0].appendChild(k)}
function waitForClientLib(){for(var k in unsafeWindow);qx=unsafeWindow.qx;ClientLib=unsafeWindow.ClientLib;webfrontend=unsafeWindow.webfrontend;"undefined"==typeof ClientLib||"undefined"==typeof qx||!1==qx.core.Init.getApplication().initDone?setTimeout(waitForClientLib,1E4):initADReport()}function startup(){setTimeout(waitForClientLib,1E4)}startup();