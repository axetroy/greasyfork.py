// ==UserScript==
// @name                WME Mapraid South Africa 2016 Overlay
// @namespace           https://greasyfork.org/users/5252
// @description         Creates polygons for MapRaid groups in a WME "Mapraid South Africa 2016 Groups" layer
// @include             https://www.waze.com/editor/*
// @include             https://www.waze.com/*/editor/*
// @include             https://editor-beta.waze.com/*
// @version             2.4
// @grant               none
// @copyright           2014 davielde
// ==/UserScript==


//---------------------------------------------------------------------------------------


//generated by rickzabel's overlay generator

//RZ RaidName will be replaced by the name of the layer in your KML file
//RZ RaidNameNoSpaces will be replaced by the name of the layer in your KML file
//RZ AreaPoints will be replaced by the names, colors, and area points from your KML file

setTimeout(InitMapRaidOverlay, 1000);

function AddRaidPolygon(raidLayer,groupPoints,groupColor,groupNumber){
    
    var mro_Map = Waze.map;
    var mro_OL = OpenLayers;
    var raidGroupLabel = 'Raid Group ' + groupNumber;
    var groupName = 'RaidGroup' + groupNumber;
    
    var style = {
        strokeColor: groupColor,
        strokeOpacity: .8,
        strokeWidth: 3,
        fillColor: groupColor,
        fillOpacity: 0.15,
        label: raidGroupLabel,
        labelOutlineColor: "black",
        labelOutlineWidth: 3,
        fontSize: 14,
        fontColor: groupColor,
        fontOpacity: .85,
        fontWeight: "bold"  
    };
    
    var attributes = {
        name: groupName,
        number: groupNumber
    };
    
    var pnt= [];
    for(i=0;i<groupPoints.length;i++){
        convPoint = new OpenLayers.Geometry.Point(groupPoints[i].lon,groupPoints[i].lat).transform(new OpenLayers.Projection("EPSG:4326"), mro_Map.getProjectionObject());
        //console.log('MapRaid: ' + JSON.stringify(groupPoints[i]) + ', ' + groupPoints[i].lon + ', ' + groupPoints[i].lat);
        pnt.push(convPoint);
    }
		       
    var ring = new mro_OL.Geometry.LinearRing(pnt);
    var polygon = new mro_OL.Geometry.Polygon([ring]);
    
    var feature = new mro_OL.Feature.Vector(polygon,attributes,style);
    raidLayer.addFeatures([feature]);

}

function CurrentRaidLocation(raid_mapLayer){
    var mro_Map = Waze.map;

    for(i=0;i<raid_mapLayer.features.length;i++){
        var raidMapCenter = mro_Map.getCenter();
        var raidCenterPoint = new OpenLayers.Geometry.Point(raidMapCenter.lon,raidMapCenter.lat);
        var raidCenterCheck = raid_mapLayer.features[i].geometry.components[0].containsPoint(raidCenterPoint);
		var holes = raid_mapLayer.features[i].attributes.holes
		
        
        if(raidCenterCheck === true){

			//var str = $('#topbar-container > div > div.location-info-region > div').text();
			var str = $('#topbar-container > div > div.topbar > div.location-info-region > div.location-info').text();
			
			var n2 = str.indexOf(" - ");
			
			if(n2 > 0){
				var n = str.length;
				var res = str.substring(n2+2, n);
				var rescount = res.indexOf(" - ");
				if(rescount>0){
					var n3 = res.length;
					var res2 = res.substring(rescount+2, n3);
				}
				var raidLocationLabel = '[Raid Group - ' + raid_mapLayer.features[i].attributes.number + '] - ' + res2;

			} else {
				//var raidLocationLabel = '[Raid Group - ' + raid_mapLayer.features[i].attributes.number + '] - ' + $('#topbar-container > div > div.location-info-region > div').text();
				var raidLocationLabel = '[Raid Group - ' + raid_mapLayer.features[i].attributes.number + '] - ' + $('#topbar-container > div > div.topbar > div.location-info-region > div.location-info').text();
						
			}	
			//setTimeout(function(){$('#topbar-container > div > div.location-info-region > div').text(raidLocationLabel);},200);
			setTimeout(function(){$('#topbar-container > div > div.topbar > div.location-info-region > div.location-info').text(raidLocationLabel);},200);
			 if (holes === "false") { break; }
		}
    }
}

function InitMapRaidOverlay(){

    var mro_Map = Waze.map;
    var mro_OL = OpenLayers;

    //if (!mro_Map) return;
	
    //if (!mro_OL) return;

    var mro_mapLayers = mro_Map.getLayersBy("uniqueName","__MapraidSouthAfrica2016");
        
    var raid_mapLayer = new mro_OL.Layer.Vector("Mapraid South Africa 2016", {
        displayInLayerSwitcher: true,
        uniqueName: "__MapraidSouthAfrica2016"
    });
        
    I18n.translations.en.layers.name["__MapraidSouthAfrica2016"] = "Mapraid South Africa 2016";
    mro_Map.addLayer(raid_mapLayer);
    raid_mapLayer.setVisibility(true);
    

var VGroup1WC = [{lon:'18.112029000000003',lat:'-32.14298599999999'},{lon:'17.724030999999997',lat:'-32.907489'},{lon:'18.357919',lat:'-34.427841'},{lon:'20.06673',lat:'-34.949444'},{lon:'23.699762',lat:'-34.1976415'},{lon:'23.4736121',lat:'-33.24649969999999'},{lon:'24.0597554',lat:'-31.497990000000016'},{lon:'22.258224999999992',lat:'-31.523484000000003'},{lon:'20.703025',lat:'-32.550564'},{lon:'20.153679',lat:'-32.090649'},{lon:'19.771297000000004',lat:'-32.180359'},{lon:'19.264482',lat:'-31.742119'},{lon:'18.9798513',lat:'-30.665197599999996'},{lon:'18.5978137',lat:'-30.7250378'},{lon:'17.77309199999999',lat:'-31.264208'},{lon:'18.112029000000003',lat:'-32.14298599999999'}];
AddRaidPolygon(raid_mapLayer, VGroup1WC,"#DB4436","Group 1 WC");

var VGroup2EC = [{lon:'24.824582000000003',lat:'-34.315672'},{lon:'26.545795000000005',lat:'-33.907689'},{lon:'28.001979000000006',lat:'-33.282972'},{lon:'29.144131999999995',lat:'-32.29012600000001'},{lon:'30.382371',lat:'-31.013598'},{lon:'29.073884100000004',lat:'-29.9517337'},{lon:'28.42099599999999',lat:'-30.117386999999994'},{lon:'28.179128000000002',lat:'-30.266058000000005'},{lon:'28.076259000000004',lat:'-30.58185'},{lon:'27.548338',lat:'-30.40139'},{lon:'25.445291',lat:'-30.71639000000002'},{lon:'24.0597554',lat:'-31.497990000000016'},{lon:'23.4736121',lat:'-33.24649969999999'},{lon:'23.699762',lat:'-34.1976415'},{lon:'24.824582000000003',lat:'-34.315672'}];
AddRaidPolygon(raid_mapLayer, VGroup2EC,"#4186F0","Group 2 EC");

var VGroup3NC = [{lon:'17.77309199999999',lat:'-31.264208'},{lon:'18.5978137',lat:'-30.7250378'},{lon:'18.9798513',lat:'-30.665197599999996'},{lon:'19.264482',lat:'-31.742119'},{lon:'19.771297000000004',lat:'-32.180359'},{lon:'20.153679',lat:'-32.090649'},{lon:'20.703025',lat:'-32.550564'},{lon:'22.258224999999992',lat:'-31.523484000000003'},{lon:'24.0597554',lat:'-31.497990000000016'},{lon:'25.445291',lat:'-30.71639000000002'},{lon:'24.22406',lat:'-29.653283'},{lon:'25.0202237',lat:'-27.9882228'},{lon:'22.226789499999995',lat:'-26.179462399999995'},{lon:'21.666534',lat:'-26.614589'},{lon:'20.92727199999999',lat:'-26.661728999999998'},{lon:'20.944321',lat:'-26.00279'},{lon:'20.498636',lat:'-24.89227'},{lon:'19.91007',lat:'-24.728541'},{lon:'19.876373',lat:'-28.371598'},{lon:'19.094123',lat:'-28.721476'},{lon:'17.22115',lat:'-27.967483'},{lon:'16.193030000000004',lat:'-28.516875000000006'},{lon:'17.77309199999999',lat:'-31.264208'}];
AddRaidPolygon(raid_mapLayer, VGroup3NC,"#7C3592","Group 3 NC");

var VGroup5KZN = [{lon:'28.9539751',lat:'-28.923255100000002'},{lon:'29.428532899999997',lat:'-29.338407'},{lon:'29.141885400000003',lat:'-29.636833199999998'},{lon:'29.073884100000004',lat:'-29.9517337'},{lon:'30.390627400000007',lat:'-31.017265100000003'},{lon:'31.3513182',lat:'-29.511653100000018'},{lon:'32.1014475',lat:'-28.9309626'},{lon:'32.4691494',lat:'-28.6096666'},{lon:'32.664007500000004',lat:'-27.936041100000008'},{lon:'32.963716',lat:'-26.840571100000005'},{lon:'31.9807081',lat:'-26.7785739'},{lon:'31.919667500000003',lat:'-27.277835999999994'},{lon:'31.3675302',lat:'-27.2372841'},{lon:'29.747518900000003',lat:'-27.0624708'},{lon:'28.9539751',lat:'-28.923255100000002'}];
AddRaidPolygon(raid_mapLayer, VGroup5KZN,"#7C3592","Group 5 KZN");

var VGroup6NW = [{lon:'25.0202237',lat:'-27.9882228'},{lon:'27.38896370000001',lat:'-26.853453'},{lon:'26.908382',lat:'-26.572968099999994'},{lon:'28.300691600000004',lat:'-24.9613199'},{lon:'26.3381393',lat:'-24.550852'},{lon:'25.842539',lat:'-24.752052'},{lon:'25.556279000000004',lat:'-25.620413000000003'},{lon:'24.768495',lat:'-25.728218'},{lon:'23.497797',lat:'-25.20914'},{lon:'22.922231',lat:'-25.219853000000004'},{lon:'22.226789499999995',lat:'-26.179462399999995'},{lon:'25.0202237',lat:'-27.9882228'}];
AddRaidPolygon(raid_mapLayer, VGroup6NW,"#4186F0","Group 6 NW");

var VGroup7GP = [{lon:'27.38896370000001',lat:'-26.853453'},{lon:'28.453323999999995',lat:'-26.951861700000006'},{lon:'29.934594000000004',lat:'-25.281554000000007'},{lon:'28.3027862',lat:'-24.961910099999997'},{lon:'26.910471999999995',lat:'-26.5735599'},{lon:'27.38896370000001',lat:'-26.853453'}];
AddRaidPolygon(raid_mapLayer, VGroup7GP,"#7C3592","Group 7 GP");

var VGroup8MP = [{lon:'31.353750799999997',lat:'-27.233618'},{lon:'30.824913799999997',lat:'-26.774591000000004'},{lon:'30.9458278',lat:'-26.353818999999994'},{lon:'31.2022928',lat:'-25.960391'},{lon:'31.3900968',lat:'-25.765065000000003'},{lon:'31.8627538',lat:'-26.025488000000003'},{lon:'32.0640998',lat:'-25.937738'},{lon:'31.997325000000004',lat:'-24.1020265'},{lon:'29.934594000000004',lat:'-25.281554000000007'},{lon:'28.45122539999999',lat:'-26.9512717'},{lon:'29.747518900000003',lat:'-27.0624708'},{lon:'31.353750799999997',lat:'-27.233618'}];
AddRaidPolygon(raid_mapLayer, VGroup8MP,"#4186F0","Group 8 MP");

var VGroup9LP = [{lon:'31.997325000000004',lat:'-24.1020265'},{lon:'31.337302300000005',lat:'-22.3199136'},{lon:'29.605426199999997',lat:'-22.063569000000008'},{lon:'28.530671699999996',lat:'-22.3392815'},{lon:'26.941967',lat:'-23.648455000000006'},{lon:'26.3381393',lat:'-24.550852'},{lon:'29.934594000000004',lat:'-25.281554000000007'},{lon:'31.997325000000004',lat:'-24.1020265'}];
AddRaidPolygon(raid_mapLayer, VGroup9LP,"#DB4436","Group 9 LP");

var VGroup4FS = [{lon:'25.445291',lat:'-30.71639000000002'},{lon:'27.548338',lat:'-30.40139'},{lon:'27.0941107',lat:'-29.6959947'},{lon:'27.447282',lat:'-29.517890000000005'},{lon:'27.695133099999996',lat:'-29.0527781'},{lon:'28.5882084',lat:'-28.6254586'},{lon:'28.9539751',lat:'-28.923255100000002'},{lon:'29.747518900000003',lat:'-27.0624708'},{lon:'27.38896370000001',lat:'-26.853453'},{lon:'25.0202237',lat:'-27.9882228'},{lon:'24.22406',lat:'-29.653283'},{lon:'25.445291',lat:'-30.71639000000002'}];
AddRaidPolygon(raid_mapLayer, VGroup4FS,"#DB4436","Group 4 FS");


    
	
	
    setTimeout(function(){CurrentRaidLocation(raid_mapLayer);},3000);
    mro_Map.events.register("moveend", Waze.map, function(){ setTimeout(function(){CurrentRaidLocation(raid_mapLayer);},1500);});
    mro_Map.events.register("zoomend", Waze.map, function(){ setTimeout(function(){CurrentRaidLocation(raid_mapLayer);},1500);});
       
       
}
